<div id="travel_planner">
  <style>
    #travelForm {
      max-width: 800px;
      margin: 0 auto;
    }

    #travelForm input:focus,
    #travelForm select:focus,
    #travelForm textarea:focus,
    #resume_optimzer #travelPlanOutput {
      outline: 2px solid #007cba;
      outline-offset: 2px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .toggle-button {
      cursor: pointer;
      padding: 2px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f0f0f0;
    }

    .collapsible-content {
      transition: max-height 0.2s ease-out;
    }
  </style>

  <form id="travelForm">
    <label for="destination">Destination:</label><br />
    <input type="text" id="destination" required style="width:100%; margin-bottom:10px;"
      aria-describedby="destinationHelp"><br />
    <div id="destinationHelp" style="display:none;">Enter your travel destination</div>

    <label for="startDate">Start Date:</label><br />
    <input type="date" id="startDate" required style="width:100%; margin-bottom:10px;"
      aria-describedby="startDateHelp"><br />
    <div id="startDateHelp" style="display:none;">Select your travel start date</div>

    <label for="endDate">End Date:</label><br />
    <input type="date" id="endDate" required style="width:100%; margin-bottom:10px;"
      aria-describedby="endDateHelp"><br />
    <div id="endDateHelp" style="display:none;">Select your travel end date</div>

    <label for="groupSize">Group Size:</label><br />
    <input type="number" id="groupSize" min="1" required style="width:100%; margin-bottom:10px;"
      aria-describedby="groupSizeHelp"><br />
    <div id="groupSizeHelp" style="display:none;">Enter the number of people traveling</div>

    <label for="groupDetails">Group Details:</label><br />
    <input type="text" id="groupDetails" style="width:100%; margin-bottom:10px;"
      aria-describedby="groupDetailsHelp"><br />
    <div id="groupDetailsHelp" style="display:none;">Enter details about the group (ages, preferences, etc.)</div>

    <button id="submit" type="submit" style="padding: 10px 20px;">Get My Travel Plan</button>
    <div id="revisionControls" style="display:none; margin-top:20px;">
      <label for="refineInput">Refine Itinerary:</label><br />
      <textarea id="refineInput" rows="3" style="width:100%; margin-bottom:10px;"></textarea><br />
      <button id="reviseBtn" type="button" style="padding: 8px 18px;">Update Itinerary</button>
    </div>
  </form>

  <div id="loadingMsg" style="display:none; text-align:center; margin-top:20px; padding:20px;">
    <div style="display:inline-block; text-align:left;">
      <p>Planning your trip... This may take a few moments.</p>
      <div
        style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 10px auto;">
      </div>
    </div>
  </div>

  <div style="text-align:center; margin-top:15px;">
    <button id="copyToClipboard" style="display:none; padding:10px 20px;">Copy to Clipboard</button>
    <div id="copySuccessMsg" style="display:none; color:green; margin-top:10px;">Travel plan copied to clipboard!</div>
  </div>

  <div id="outputArea" style="display: none; margin-top: 10px;">
    <!-- <label for="travelPlanOutput">Your Travel Plan:</label><br /> -->
    <div id="travelPlanOutput" style="margin-top: 20px; border:1px solid #ccc; padding:15px;"></div>
    <label for="verificationOutput" style="margin-top:20px; display:block;">Verification:</label> <button id="toggleVerification" type="button" class="toggle-button" style="margin-left: 10px;">Show</button>
    <div id="verificationOutput" style="display: none; margin-top: 10px; border:1px solid #eee; padding:12px; background:#fafafa;">
    </div>
  </div>
</div>

<script>

  // --- Conversation History State ---
  /**
   * @typedef {Object} Message
   * @property {'system'|'user'|'assistant'} role
   * @property {string} content
   */
  /** @type {Message[]} */
  let conversation = [];
  let latestTravelPlan = "";
  let inRevisionMode = false;

  const loadingMsg = document.getElementById("loadingMsg");
  const outputArea = document.getElementById("outputArea");
  const travelPlanOutput = document.getElementById("travelPlanOutput");
  const verificationOutput = document.getElementById("verificationOutput");
  const copyBtn = document.getElementById("copyToClipboard");

  // Helper: Build initial conversation from form
  function buildInitialConversation(formData) {
    return [
      {
        role: 'system',
        content: 'You are a travel planner. Generate detailed, feasible itineraries.'
      },
      {
        role: 'user',
        content: `Generate a travel plan based on these details: ${JSON.stringify(formData)}`
      }
    ];
  }

  // Helper: Enter revision mode UI
  function enterRevisionMode() {
    inRevisionMode = true;
    document.getElementById('revisionControls').style.display = 'block';
    // don't we want to disable this???
    // document.getElementById('submit').textContent = 'Update Itinerary';
    document.getElementById('submit').disabled = true;
    document.getElementById('destination').disabled = true;
    document.getElementById('startDate').disabled = true;
    document.getElementById('endDate').disabled = true;
    document.getElementById('groupSize').disabled = false;
    document.getElementById('groupDetails').disabled = false;
  }

  // Helper: Reset revision mode UI
  function resetRevisionMode() {
    inRevisionMode = false;
    document.getElementById('revisionControls').style.display = 'none';
    document.getElementById('submit').textContent = 'Get My Travel Plan';
    document.getElementById('destination').disabled = false;
    document.getElementById('startDate').disabled = false;
    document.getElementById('endDate').disabled = false;
    document.getElementById('groupSize').disabled = false;
    document.getElementById('groupDetails').disabled = false;
    document.getElementById('refineInput').value = '';
    conversation = [];
  }

  // --- Main Planner Logic ---
  const travelPlanner = async (isRevision = false) => {
    loadingMsg.style.display = "block";
    travelPlanOutput.innerHTML = "";
    if (verificationOutput) verificationOutput.innerHTML = "";
    copyBtn.style.display = "none";

  const destination = document.getElementById("destination").value.trim();
  const startDate = document.getElementById("startDate").value.trim();
  const endDate = document.getElementById("endDate").value.trim();
  const groupSize = document.getElementById("groupSize").value;
  const groupDetails = document.getElementById("groupDetails").value;
    // Validation
    const isValidForm = (destination, startDate, endDate, groupSize) => {
      return (
      destination &&
      startDate &&
      endDate &&
      groupSize &&
      !isNaN(Number(groupSize)) &&
      Number(groupSize) >= 1
      );
    };


    if (!isRevision && !isValidForm(destination, startDate, endDate, groupSize)) {
      travelPlanOutput.innerHTML = "Please fill out all fields correctly.";
      outputArea.style.display = "block";
      loadingMsg.style.display = "none";
      if (verificationOutput) verificationOutput.innerHTML = "";
      return;
    }

    try {
      let payload;
      if (!isRevision) {
        // Initial generation: build conversation from form
        const formData = {
          destination,
          dates: [startDate, endDate],
          groupSize: Number(groupSize),
          groupDetails
        };
        conversation = buildInitialConversation(formData);
        payload = { conversation };
      } else {
        // Revision: add user instruction to conversation
        const instruction = document.getElementById('refineInput').value.trim();
        if (!instruction) {
          loadingMsg.style.display = "none";
          return;
        }
        conversation.push({ role: 'user', content: instruction });
        payload = { conversation };
      }

      // NOTE: since we manually "deploy" to Squarespace we manually change for local dev sigh
      const response = await fetch("https://resume-refresh-api.vercel.app/api/travel", {
      // const response = await fetch("http://localhost:3000/api/travel", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await response.json();
      if (data.travelPlan) {
        outputArea.style.display = "block";
        copyBtn.style.display = "inline-block";
        travelPlanOutput.innerHTML = data.travelPlan;
        latestTravelPlan = data.travelPlan;
        if (verificationOutput && data.verification) {
          verificationOutput.innerHTML = data.verification;
        }
        // Add assistant response to conversation
        if (data.rawPlan) {
          conversation.push({ role: 'assistant', content: data.rawPlan });
        }
        if (!inRevisionMode) {
          enterRevisionMode();
        }
        document.getElementById('refineInput').value = '';
      } else {
        travelPlanOutput.innerHTML = "Sorry, there was a problem processing your travel plan.";
        if (verificationOutput) verificationOutput.innerHTML = "";
      }
    } catch (err) {
      console.error("Error connecting to the travel service:", err);
      travelPlanOutput.innerHTML = "Error connecting to the travel service. Please try again later.";
      if (verificationOutput) verificationOutput.innerHTML = "";
    } finally {
      loadingMsg.style.display = "none";
    }
  };


  document.getElementById("travelForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    await travelPlanner(false);
  });

  // Revision button handler
  document.getElementById('reviseBtn').addEventListener('click', async function () {
    await travelPlanner(true);
  });

  document.getElementById("toggleVerification").addEventListener("click", function() {
    const verificationOutput = document.getElementById("verificationOutput");
    const isHidden = verificationOutput.style.display === "none";
    verificationOutput.style.display = isHidden ? "block" : "none";
    this.textContent = isHidden ? "Hide" : "Show";
  });

  const getTravelPlanText = () => {
    // Strip HTML tags for clipboard copy
    const tempDiv = document.createElement('div');
    const travelOutput = document.getElementById("travelOutput");
    tempDiv.innerHTML = travelOutput.innerHTML;
    return tempDiv.textContent || tempDiv.innerText || "";
  };

  copyBtn.addEventListener("click", () => {
    const plan = getTravelPlanText();
    const copySuccessMsg = document.getElementById("copySuccessMsg");

    navigator.clipboard.writeText(plan)
      .then(() => {
        copySuccessMsg.style.display = "block";
        setTimeout(() => {
          copySuccessMsg.style.display = "none";
        }, 3000);
      })
      .catch(err => {
        console.error("Failed to copy text: ", err);
        alert("Failed to copy text to clipboard. Please try again.");
      });
  });
</script>